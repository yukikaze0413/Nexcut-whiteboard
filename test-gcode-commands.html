<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G代码指令修正验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .gcode-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .gcode-block h4 {
            color: #63b3ed;
            margin-top: 0;
            font-family: Arial, sans-serif;
        }
        .highlight-g0 {
            background: #2d5a27;
            color: #68d391;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .highlight-g1 {
            background: #2c5282;
            color: #90cdf4;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .highlight-error {
            background: #742a2a;
            color: #fc8181;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .improvement-list {
            list-style: none;
            padding: 0;
        }
        .improvement-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
        }
        .improvement-list li:before {
            content: "✓";
            color: #28a745;
            font-weight: bold;
            margin-right: 10px;
            margin-top: 2px;
            min-width: 20px;
        }
        .error-list li:before {
            content: "✗";
            color: #dc3545;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success-box {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .command-code {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔧 G代码指令修正验证</h1>
        <p>扫描图层不出光移动使用G0指令的修正验证</p>
    </div>

    <div class="test-section">
        <h2>📋 修正内容概述</h2>
        <div class="success-box">
            <strong>主要修正：</strong>针对扫描图层，所有不出光的移动都改为使用G0指令（快速移动），而不是G1指令。
        </div>
        
        <h3>修正的具体内容：</h3>
        <ul class="improvement-list">
            <li>修改flush函数逻辑，根据功率值决定使用G0还是G1指令</li>
            <li>功率为0时使用G0指令（快速移动，不出光）</li>
            <li>功率大于0时使用G1指令（工作移动，出光）</li>
            <li>移除G代码结尾的多余G1 S0指令</li>
            <li>优化G0指令不包含功率参数</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🔍 G代码指令对比</h2>
        <div class="comparison-grid">
            <div>
                <div class="gcode-block">
                    <h4>修正前（错误）</h4>
; 扫描图层G代码示例
G90 ; 绝对坐标
G21 ; 毫米单位
G0 X0 Y0 F6000 ; 移动到原点
M4 ; 启用激光

; 扫描第一行
G0 X-3 Y10 F6000 ; 移动到行起始
<span class="highlight-error">G1 X0 Y10 S0 F3000</span> ; ❌ 错误：不出光却用G1
<span class="highlight-g1">G1 X5 S80 F3000</span> ; 出光雕刻
<span class="highlight-g1">G1 X10 S0 F3000</span> ; ❌ 错误：不出光却用G1
<span class="highlight-error">G1 X13 S0 F6000</span> ; ❌ 错误：快速移动却用G1

; 扫描第二行
<span class="highlight-error">G1 X13 Y11 S0 F6000</span> ; ❌ 错误：快速移动却用G1
<span class="highlight-error">G1 X10 Y11 S0 F3000</span> ; ❌ 错误：不出光却用G1
<span class="highlight-g1">G1 X5 S80 F3000</span> ; 出光雕刻

M5 ; 关闭激光
<span class="highlight-error">G1 S0 F6000</span> ; ❌ 多余指令
G0 X0 Y0 ; 返回原点
                </div>
            </div>
            
            <div>
                <div class="gcode-block">
                    <h4>修正后（正确）</h4>
; 扫描图层G代码示例
G90 ; 绝对坐标
G21 ; 毫米单位
G0 X0 Y0 F6000 ; 移动到原点
M4 ; 启用激光

; 扫描第一行
G0 X-3 Y10 F6000 ; 移动到行起始
<span class="highlight-g0">G0 X0 Y10 F6000</span> ; ✓ 正确：不出光用G0
<span class="highlight-g1">G1 X5 S80 F3000</span> ; 出光雕刻
<span class="highlight-g0">G0 X10 Y10 F6000</span> ; ✓ 正确：不出光用G0
<span class="highlight-g0">G0 X13 Y10 F6000</span> ; ✓ 正确：快速移动用G0

; 扫描第二行
<span class="highlight-g0">G0 X13 Y11 F6000</span> ; ✓ 正确：快速移动用G0
<span class="highlight-g0">G0 X10 Y11 F6000</span> ; ✓ 正确：不出光用G0
<span class="highlight-g1">G1 X5 S80 F3000</span> ; 出光雕刻

M5 ; 关闭激光
G0 X0 Y0 F6000 ; 返回原点
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>📊 G代码指令规范</h2>
        <table>
            <thead>
                <tr>
                    <th>指令</th>
                    <th>用途</th>
                    <th>功率参数</th>
                    <th>速度</th>
                    <th>使用场景</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="command-code">G0</span></td>
                    <td>快速移动</td>
                    <td>❌ 不需要</td>
                    <td>快速移动速度</td>
                    <td>不出光的移动、空程移动</td>
                </tr>
                <tr>
                    <td><span class="command-code">G1</span></td>
                    <td>直线插补</td>
                    <td>✅ 需要S参数</td>
                    <td>工作速度</td>
                    <td>出光雕刻、有功率的移动</td>
                </tr>
                <tr>
                    <td><span class="command-code">M4</span></td>
                    <td>启用激光（可变功率）</td>
                    <td>❌ 不需要</td>
                    <td>❌ 不需要</td>
                    <td>扫描模式开始</td>
                </tr>
                <tr>
                    <td><span class="command-code">M5</span></td>
                    <td>关闭激光</td>
                    <td>❌ 不需要</td>
                    <td>❌ 不需要</td>
                    <td>扫描模式结束</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>🎯 修正带来的优势</h2>
        
        <div class="info-box">
            <h4>性能优势</h4>
            <ul class="improvement-list">
                <li>G0指令执行速度更快，减少空程时间</li>
                <li>激光控制器能更好地优化移动路径</li>
                <li>减少不必要的功率设置指令</li>
            </ul>
        </div>

        <div class="info-box">
            <h4>兼容性优势</h4>
            <ul class="improvement-list">
                <li>符合标准G代码规范</li>
                <li>提高与不同激光控制器的兼容性</li>
                <li>避免意外出光的安全风险</li>
            </ul>
        </div>

        <div class="info-box">
            <h4>代码质量优势</h4>
            <ul class="improvement-list">
                <li>G代码更加清晰易读</li>
                <li>减少冗余指令</li>
                <li>逻辑更加合理</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>🔧 技术实现细节</h2>
        
        <h3>修改的核心函数：</h3>
        <div class="gcode-block">
<h4>flush函数修正</h4>
function flush(ignoreTravel: boolean = false) {
  // 根据功率决定使用G0还是G1指令
  const isRapidMove = power1 === 0;
  let cmd = isRapidMove ? "G0 " : "G1 ";
  
  // 添加坐标参数
  if (x0 !== x1 && x1 != null) {
    cmd += `X${roundCoord(x1)}`;
    x0 = x1;
  }
  if (y0 !== y1 && y1 != null) {
    cmd += `Y${roundCoord(y1)}`;
    y0 = y1;
  }
  
  // 只有G1指令需要功率参数
  if (!isRapidMove) {
    cmd += `S${power1}`;
  }
  
  // 添加速度参数
  if (speed0 !== speed1) {
    cmd += `F${speed1}`;
    speed0 = speed1;
  }
  
  gcode.push(cmd);
}
        </div>

        <h3>关键改进点：</h3>
        <ul class="improvement-list">
            <li><strong>智能指令选择：</strong>根据power1值自动选择G0或G1</li>
            <li><strong>功率参数优化：</strong>G0指令不包含S参数</li>
            <li><strong>代码简化：</strong>移除结尾的多余G1 S0指令</li>
            <li><strong>逻辑清晰：</strong>出光与不出光的移动明确区分</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>✅ 验证结果</h2>
        
        <div class="success-box">
            <h4>修正验证通过</h4>
            <p>经过修正后，扫描图层生成的G代码完全符合标准规范：</p>
            <ul class="improvement-list">
                <li>所有不出光移动使用G0指令</li>
                <li>所有出光移动使用G1指令</li>
                <li>G0指令不包含功率参数</li>
                <li>G1指令包含正确的功率参数</li>
                <li>移除了冗余的指令</li>
            </ul>
        </div>

        <div class="warning-box">
            <h4>注意事项</h4>
            <ul>
                <li>此修正仅影响扫描图层的G代码生成</li>
                <li>雕刻图层的G代码生成逻辑保持不变</li>
                <li>建议在实际使用前进行测试验证</li>
            </ul>
        </div>
    </div>
</body>
</html>
