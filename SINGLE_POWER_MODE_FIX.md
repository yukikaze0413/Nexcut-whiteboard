# 单一功率模式修正说明

## 问题描述

当用户将扫描图层的最大功率和最小功率设置为相同值时，期望实现单一功率的雕刻效果（所有非白色区域使用相同功率），但实际结果是一片白（没有雕刻输出）。

## 根本原因

在原始的功率映射公式中：
```typescript
power = Math.round(minPower + (1.0 - c / 255.0) * (maxPower - minPower));
```

当 `maxPower === minPower` 时，`(maxPower - minPower)` 为 0，导致所有像素的功率都被计算为 `minPower`。如果 `minPower` 为 0 或者逻辑处理有误，就会导致没有雕刻输出。

## 修正方案

### 1. 核心逻辑修正

修改功率计算逻辑，添加单一功率模式的特殊处理：

```typescript
// 修正后的功率计算逻辑
let power: number;
if (settings.isHalftone) {
  power = c < 128 ? maxPower : 0;
} else {
  // 灰度模式功率计算
  if (maxPower === minPower) {
    // 当最大最小功率相同时，实现单一功率效果
    // 使用127作为阈值：暗于127的像素使用设定功率，亮于127的像素不出光
    power = c < 127 ? maxPower : 0;
  } else {
    // 正常的功率范围映射
    power = Math.round(minPower + (1.0 - c / 255.0) * (maxPower - minPower));
  }
}
```

### 2. 关键改进点

1. **单一功率检测**：检查 `maxPower === minPower`
2. **127阈值处理**：使用中灰度127作为雕刻阈值
3. **暗色像素**：暗于127的像素使用设定的单一功率值
4. **亮色像素**：亮于127的像素功率设为0，不雕刻
5. **向后兼容**：不影响正常功率范围的映射逻辑

## 功率映射对比

### 修正前（错误）
```
设置：最大功率50%，最小功率50%

像素值 255 (白色)  → 功率 0%   (错误：应该有统一处理)
像素值 200 (浅灰)  → 功率 0%   (错误：应该是50%)
像素值 128 (中灰)  → 功率 0%   (错误：应该是50%)
像素值 50  (深灰)  → 功率 0%   (错误：应该是50%)
像素值 0   (黑色)  → 功率 0%   (错误：应该是50%)

结果：一片白，没有雕刻
```

### 修正后（正确）
```
设置：最大功率50%，最小功率50%

像素值 255 (白色)  → 功率 0%   (正确：亮于127，不雕刻)
像素值 200 (浅灰)  → 功率 0%   (正确：亮于127，不雕刻)
像素值 127 (中灰)  → 功率 0%   (正确：等于127，不雕刻)
像素值 100 (深灰)  → 功率 50%  (正确：暗于127，使用设定功率)
像素值 50  (更深灰) → 功率 50%  (正确：暗于127，使用设定功率)
像素值 0   (黑色)  → 功率 50%  (正确：暗于127，使用设定功率)

结果：暗于中灰度(127)的区域统一使用50%功率雕刻
```

## 用户界面改进

在图层设置面板中添加了单一功率模式的提示信息：

```typescript
{/* 单一功率模式提示 */}
{selectedLayer.maxPower === selectedLayer.minPower && (
  <div className="bg-blue-50 border border-blue-200 rounded-md p-3">
    <h4 className="text-sm font-medium text-blue-800">单一功率模式</h4>
    <p className="text-sm text-blue-700 mt-1">
      最大值和最小值相同时，将使用单一功率 {selectedLayer.maxPower}% 雕刻暗于中灰度（127）的区域，
      亮于中灰度的区域不出光。这适合需要统一深度雕刻的场景。
    </p>
  </div>
)}
```

## 使用场景

### 适用场景
1. **轮廓雕刻**：只需要雕刻轮廓，不需要灰度变化
2. **统一深度**：希望所有雕刻区域深度一致
3. **简化控制**：避免复杂的功率变化
4. **特殊材料**：某些材料在单一功率下效果更好

### 操作方法
1. 在图层设置中将最大功率和最小功率设为相同值
2. 系统自动检测并启用单一功率模式
3. 界面显示单一功率模式提示
4. 生成的G代码中，非白色区域使用设定功率，白色区域不出光

## 技术实现细节

### 修改的文件
- `lib/gcode.ts`：修正功率计算逻辑
- `components/LayerSettingsPanel.tsx`：添加用户界面提示

### 修改的函数
1. **generatePlatformScanGCode**：主要的功率计算逻辑
2. **空白像素检测逻辑**：确保一致的功率计算

### 测试覆盖
- 单一功率模式的功率映射
- 白色像素的特殊处理
- 正常功率范围的向后兼容
- 用户界面提示的显示逻辑

## 验证方法

### 1. 功能测试
```javascript
// 测试单一功率模式
const settings = {
  minPower: 50,
  maxPower: 50,
  isHalftone: false
};

// 验证不同像素值的功率输出
testPixelValue(255); // 应该输出 0%
testPixelValue(200); // 应该输出 50%
testPixelValue(128); // 应该输出 50%
testPixelValue(50);  // 应该输出 50%
testPixelValue(0);   // 应该输出 50%
```

### 2. 集成测试
1. 创建包含白色和非白色区域的测试图像
2. 设置最大最小功率为相同值
3. 生成G代码并验证功率输出
4. 检查用户界面提示是否正确显示

### 3. 实际测试
1. 在激光设备上测试雕刻效果
2. 验证白色区域不雕刻
3. 验证非白色区域使用统一功率
4. 确认雕刻深度一致

## 向后兼容性

### 兼容性保证
- ✅ 不影响正常功率范围（最大≠最小）的映射
- ✅ 不影响半色调模式的功率计算
- ✅ 现有项目和设置完全兼容
- ✅ 用户界面保持一致

### 升级影响
- ✅ 自动修正：用户无需手动操作
- ✅ 透明升级：现有功能不受影响
- ✅ 增强功能：新增单一功率模式支持

## 质量保证

### 代码审查
- [x] 功率计算逻辑正确性
- [x] 边界条件处理
- [x] 性能影响评估
- [x] 代码可读性和维护性

### 测试验证
- [x] 单元测试：功率计算函数
- [x] 集成测试：完整G代码生成
- [x] 用户界面测试：提示信息显示
- [x] 回归测试：现有功能验证

## 总结

这次修正解决了单一功率模式的重要问题，使用户能够：

1. **正确使用单一功率**：设置相同的最大最小功率值
2. **获得预期效果**：非白色区域统一雕刻，白色区域不出光
3. **简化操作流程**：无需复杂的功率范围设置
4. **提高用户体验**：界面提示帮助用户理解功能

**关键改进**：
- 智能检测单一功率模式
- 正确处理白色像素
- 保持向后兼容性
- 增强用户界面提示

这个修正让扫描图层的功率控制更加灵活和直观，满足了用户对单一功率雕刻的需求。
