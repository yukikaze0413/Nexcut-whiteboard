# G代码指令修正说明

## 问题描述

在之前的实现中，扫描图层生成的G代码存在一个重要问题：**所有移动都使用G1指令，包括不出光的移动**。这不符合G代码标准规范，也会影响激光雕刻的效率和安全性。

## 标准规范

根据G代码标准：
- **G0指令**：快速移动，用于不出光的空程移动
- **G1指令**：直线插补，用于有功率输出的工作移动

## 修正内容

### 1. 核心函数修正

修改了 `lib/gcode.ts` 中的 `flush` 函数：

```typescript
// 修正前（错误）
function flush(ignoreTravel: boolean = false) {
  let cmd = "G1 ";  // ❌ 总是使用G1
  // ... 添加坐标和功率参数
  cmd += `S${power1}`;  // ❌ 即使功率为0也添加S参数
  gcode.push(cmd);
}

// 修正后（正确）
function flush(ignoreTravel: boolean = false) {
  const isRapidMove = power1 === 0;
  let cmd = isRapidMove ? "G0 " : "G1 ";  // ✅ 根据功率选择指令
  
  // 添加坐标参数...
  
  // 只有G1指令需要功率参数
  if (!isRapidMove) {
    cmd += `S${power1}`;  // ✅ G0指令不包含S参数
  }
  
  gcode.push(cmd);
}
```

### 2. 结尾指令优化

移除了G代码结尾的冗余指令：

```gcode
; 修正前
M5 ; Disable laser
G1 S0 F6000 ; ❌ 多余的指令
G0 X0 Y0 ; Return to origin

; 修正后
M5 ; Disable laser
G0 X0 Y0 F6000 ; ✅ 直接快速返回原点
```

## 修正效果对比

### 修正前的G代码（错误）
```gcode
; 扫描示例
G0 X-3 Y10 F6000        ; 移动到行起始
G1 X0 Y10 S0 F3000      ; ❌ 不出光却用G1
G1 X5 S80 F3000         ; 出光雕刻
G1 X10 S0 F3000         ; ❌ 不出光却用G1
G1 X13 S0 F6000         ; ❌ 快速移动却用G1
```

### 修正后的G代码（正确）
```gcode
; 扫描示例
G0 X-3 Y10 F6000        ; 移动到行起始
G0 X0 Y10 F6000         ; ✅ 不出光用G0
G1 X5 S80 F3000         ; 出光雕刻
G0 X10 Y10 F6000        ; ✅ 不出光用G0
G0 X13 Y10 F6000        ; ✅ 快速移动用G0
```

## 修正带来的优势

### 1. 性能优势
- **更快的空程移动**：G0指令执行速度更快
- **减少指令处理时间**：G0指令不需要处理功率参数
- **优化的移动路径**：激光控制器能更好地优化G0移动

### 2. 安全优势
- **避免意外出光**：明确区分出光和不出光移动
- **符合安全规范**：遵循激光设备的标准操作规范
- **降低风险**：减少因指令错误导致的安全问题

### 3. 兼容性优势
- **标准规范**：符合国际G代码标准
- **设备兼容**：提高与不同激光控制器的兼容性
- **软件兼容**：与主流CAM软件生成的G代码格式一致

### 4. 代码质量优势
- **逻辑清晰**：出光与不出光的移动明确区分
- **代码简洁**：减少冗余指令
- **易于理解**：G代码更加直观易读

## 影响范围

### 受影响的功能
- ✅ **扫描图层G代码生成**：主要修正目标
- ✅ **平台扫描功能**：使用相同的生成逻辑
- ✅ **图像扫描处理**：所有扫描相关功能

### 不受影响的功能
- ❌ **雕刻图层G代码生成**：使用不同的生成逻辑
- ❌ **矢量图形G代码**：已经正确使用G0/G1指令
- ❌ **其他非扫描功能**：不涉及此修正

## 验证方法

### 1. 代码审查
- 检查 `flush` 函数的修正逻辑
- 验证G0/G1指令的选择条件
- 确认功率参数的正确处理

### 2. G代码检查
- 生成测试G代码文件
- 验证不出光移动使用G0指令
- 确认出光移动使用G1指令

### 3. 实际测试
- 使用激光设备测试生成的G代码
- 验证移动速度和效率
- 确认安全性和准确性

## 测试用例

### 测试场景1：简单扫描
```gcode
; 预期结果
G0 X0 Y0 F6000          ; 快速移动到起始位置
G0 X-3 Y10 F6000        ; 快速移动到行起始
G1 X5 S80 F3000         ; 出光雕刻
G0 X8 Y10 F6000         ; 快速跳过空白区域
G1 X15 S60 F3000        ; 继续出光雕刻
```

### 测试场景2：多行扫描
```gcode
; 预期结果
G0 X-3 Y10 F6000        ; 第一行起始
G1 X0 S0 F3000          ; 开始扫描（可能为0功率）
G1 X5 S80 F3000         ; 出光区域
G0 X10 Y10 F6000        ; 跳过空白
G0 X10 Y11 F6000        ; 移动到下一行
G1 X5 S60 F3000         ; 反向扫描
```

## 向后兼容性

### 兼容性保证
- ✅ **现有项目**：不影响已保存的项目文件
- ✅ **图层设置**：所有图层参数保持兼容
- ✅ **用户界面**：界面功能完全不变

### 升级影响
- ✅ **自动应用**：修正会自动应用到新生成的G代码
- ✅ **无需迁移**：不需要用户手动迁移数据
- ✅ **透明升级**：用户无感知的功能改进

## 质量保证

### 代码审查
- [x] 核心逻辑修正
- [x] 边界条件处理
- [x] 错误处理机制
- [x] 性能影响评估

### 测试覆盖
- [x] 单元测试：flush函数逻辑
- [x] 集成测试：完整G代码生成
- [x] 回归测试：现有功能验证
- [x] 性能测试：生成速度对比

## 总结

这次修正解决了扫描图层G代码生成中的一个重要问题，使生成的G代码完全符合标准规范。修正后的代码不仅提高了执行效率和安全性，还增强了与各种激光设备的兼容性。

**关键改进**：
1. 不出光移动使用G0指令
2. 出光移动使用G1指令  
3. G0指令不包含功率参数
4. 移除冗余指令
5. 提高代码质量和可读性

这个修正是一个重要的质量改进，为用户提供更加标准、高效、安全的G代码输出。
